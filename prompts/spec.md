# Git Utils 脚本开发规范

本规范适用于 `git-utils.sh` 项目下的所有 Bash 脚本开发，旨在确保代码风格统一、跨平台兼容性好、且具备完善的测试覆盖。

## 1. 代码风格约束 (Code Style)

### 1.1. 解释器与环境
- **解释器**: 所有脚本必须以 `#!/bin/bash` 开头。
- **执行环境**: 主要针对 Windows 环境下的 Git Bash。
- **入口模式**: 必须使用 `main` 函数作为入口，并包含以下守卫代码，确保脚本既可执行也可被 source：
  ```bash
  if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
      main "$@"
  fi
  ```

### 1.2. 命名规范
- **函数名**: 使用小写字母和下划线 (`snake_case`)，如 `show_help`, `process_file`。
- **变量名**:
  - 全局变量/常量/环境变量：使用大写字母 (`UPPER_CASE`)，如 `PROJECT_ROOT`, `TARGET_FILE`。
  - 局部变量：使用小写字母 (`snake_case`)，建议使用 `local` 关键字声明。
- **文件名**: 使用小写字母和下划线，后缀为 `.sh`。

### 1.3. 跨平台兼容性 (Windows/Linux)
由于主要在 Windows 下运行，必须注意换行符问题：
- **读取文件**: 处理文件输入时，必须使用 `tr -d '\r'` 移除 Windows 的 CRLF 换行符。
  - *错误示例*: `grep "$PATTERN" .gitignore`
  - *正确示例*: `grep "$PATTERN" <(tr -d '\r' < .gitignore)`

## 2. 注释风格约束 (Comment Style)

### 2.1. 函数注释
每个功能函数上方必须包含简短的中文注释，说明函数的作用。

### 2.2. 逻辑注释
对于复杂的命令（特别是 Git 命令参数）或关键逻辑分支，必须在代码上方添加注释，解释“为什么”这样做。

```bash
# 1. 停止 Git 追踪
# --cached: 只从索引中移除，保留工作区文件（不影响原来文件内容）
# --ignore-unmatch: 如果文件没被追踪，也不报错
git rm -r --cached --ignore-unmatch "$TARGET" 2>/dev/null
```

## 3. 输入输出风格约束 (I/O Style)

### 3.1. 帮助信息
- 所有脚本必须支持 `-h` 或 `--help` 参数作为第一个参数。
- `show_help` 函数应清晰列出：用法 (Usage)、描述 (Description)、参数 (Parameters)、示例 (Examples)。

### 3.2. 运行时反馈
- **分隔符**: 使用 `--------------------------------` 分隔不同阶段的输出，提升可读性。
- **状态前缀**: 使用统一的前缀（如 `状态: ...` 或 `[INFO] ...`）来标识脚本正在进行的操作。
- **静默处理**:
  - 对于检查性质的命令（如检查文件是否存在），应将错误输出重定向到 `/dev/null`。
  - 示例: `command 2>/dev/null`。

## 4. 测试文件风格约束 (Test Style)

### 4.1. 文件位置
- 所有测试脚本存放在 `__test__/` 目录下。
- 命名格式: `original_script_name.test.sh`。

### 4.2. 测试结构
测试脚本必须包含以下基础结构：
1.  **颜色定义**: 定义 `GREEN`, `RED`, `NC` 用于输出彩色结果。
2.  **日志函数**: 定义 `log_info`, `log_success`, `log_fail`。
3.  **Setup/Cleanup**:
    - `setup()`: 创建独立的测试沙箱目录（如 `test_playground`），初始化 Git 仓库。
    - `cleanup()`: 测试结束后清理沙箱目录。
4.  **独立测试用例**: 每个测试场景封装为一个函数。
5.  **Main Runner**: 统计 PASS/FAIL 数量，并返回相应的退出码（全通过为 0，有失败为 1）。

### 4.3. 验证原则

#### 对于git相关功能的测试
- **文件系统验证**: 检查文件是否存在/被删除。
- **Git 状态验证**: 使用 `git ls-files` 或 `git status` 验证文件的 Git 追踪状态。
- **配置文件验证**: 检查 `.gitignore` 等配置文件内容是否正确更新。

#### 对于非git相关功能的测试
- **功能验证**: 检查脚本是否按预期执行，输出是否符合预期。
- **错误处理**: 测试脚本是否正确处理异常情况（如无效参数、文件不存在等）。

####
- 测试脚本需要产生一份报告
    - 报告内容包括测试用例的执行结果（PASS/FAIL）、执行时间、测试覆盖范围等。
    - 报告文件存放在 `__test__/report/` 目录下，文件名与测试脚本相同（但后缀为 `.md`）。-

报告格式要求如下：
```
# 测试报告: original_script_name.test.sh

- **测试时间**: 2024-01-20 10:00:00
- **执行环境**: Windows_NT (Git Bash)

## 测试用例详情

| 测试用例 | 结果 | 耗时 | 备注 |
| :--- | :--- | :--- | :--- |
| 测试内容1 | PASS | 0.12s | 测试内容1结果 |
| 测试内容2 | FAIL | 0.2s | 测试内容2结果 |
| 测试内容3 | PASS | 0.3s | 测试内容3结果 |

## 统计汇总
- **总计**: 2
- **通过**: 2
- **失败**: 0
```

### 4.4. 测试脚本模板
```bash
#!/bin/bash
# ... 颜色和日志函数定义 ...

setup() {
    # 创建沙箱，初始化 git
}

test_feature_x() {
    # 1. 准备数据
    # 2. 运行目标脚本
    # 3. 验证结果 (Assert)
}

main() {
    setup
    test_feature_x
    # ... 汇总结果 ...
}
main
```
